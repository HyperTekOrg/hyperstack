name: Release Rust Crates

on:
  push:
    tags:
      - 'hyperstack-v*'
      - 'hyperstack-interpreter-v*'
      - 'hyperstack-spec-macros-v*'
      - 'hyperstack-cli-v*'
      - 'hyperstack-server-v*'
      # TODO: Uncomment when Rust SDK is ready
      # - 'hyperstack-sdk-rust-v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Login to crates.io
        run: cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish hyperstack-spec-macros
        run: |
          cd spec-macros
          cargo publish --allow-dirty || echo "Package may already be published"
          sleep 30

      - name: Publish hyperstack-interpreter
        run: |
          cd interpreter
          cargo publish --allow-dirty || echo "Package may already be published"
          sleep 30

      - name: Publish hyperstack-server
        run: |
          cd rust/hyperstack-server
          cargo publish --allow-dirty || echo "Package may already be published"
          sleep 30

      # TODO: Uncomment when Rust SDK is ready
      # - name: Publish hyperstack-sdk
      #   run: |
      #     cd rust/hyperstack-sdk
      #     cargo publish --allow-dirty || echo "Package may already be published"
      #     sleep 30

      - name: Publish hyperstack (umbrella)
        run: |
          cd hyperstack
          cargo publish --allow-dirty || echo "Package may already be published"
          sleep 30

      - name: Publish hyperstack-cli
        run: |
          cd cli
          cargo publish --allow-dirty || echo "Package may already be published"
